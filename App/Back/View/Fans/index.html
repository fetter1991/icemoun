<extend name="Public/admin" />
<block name="style">
    <link href="__MC__/global/plugins/bootstrap-select/css/bootstrap-select.min.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
        table td{
            vertical-align: middle !important;
        }
        #modalbody{
            overflow-y: scroll !important;
            max-height: 400px !important;
        }
    </style>
</block>
<block name="content">
    <div class="row">
        <div class="col-md-6 col-sm-6 pull-right">
            <div id="sample_1_filter" class="dataTables_filter">
                <form class="form-horizontal" role="form" action="{:U('Fans/index')}" method="get">

                    <div class="col-lg-4">
                        <select id="select" name="val" class="form-control selectpicker" data-live-search="true" data-max-options="1"  style="width: 110px;height: 35px;">
                            <option value="0">全部渠道</option>
                            <volist name="channellist" id="vo">
                                <option value="{$vo.id}" <if condition="$val eq $vo['id']"> selected<else/></if>>{$vo.nick_name}</option>
                            </volist>
                        </select>
                    </div>
                    <div class="col-lg-4">
                        <select name="pay" class="form-control" id="pay">
                            <option value="0">全部</option>
                            <option value="1"
                            <if condition="$pay == 1">selected</if>>已充值</option>
                            <option value="2"
                            <if condition="$pay == 2">selected</if>>未充值</option>
                        </select>
                    </div>
                    <div class="col-lg-4">
                            <div class="input-group">
                            <input type="text" value="{$keywords}" name="nick_name" class="form-control" placeholder="请输入ID搜索">
                            <span class="input-group-btn">
                                    <button class="btn green" type="submit">搜索</button>
                                </span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="row" style="margin-top: 10px;">
        <div class="col-md-12 col-sm-12">
            <table class="table table-bordered table-striped table-condensed flip-content">
                <thead>
                    <tr>
                        <th class="text-center">ID</th>
                        <th class="text-center">昵称</th>
                        <th class="text-center">vip状态</th>
                        <th class="text-center">性别</th>
                        <th class="text-center">头像</th>
                        <th class="text-center">是否关注</th>
                        <th class="text-center">阅读币</th>
                        <th class="text-center">充值金额(元)</th>
                        <th class="text-center">消费记录</th>
                        <th class="text-center">充值记录</th>
                        <th class="text-center">引导时间</th>
                        <th class="text-center">来源</th>
                        <th class="text-center">操作</th>
                    </tr>
                </thead>
                <tbody>
                    <if condition="$flag eq 1">
                        <volist name="userlist" id="vo">
                            <tr>
                                <td class="text-center">{$vo.id}</td>
                                <td class="text-center">{$vo.nick_name}</td>
                                <td class="text-center">
                                    <if condition="$vo['is_vip'] == 1">
                                        vip过期时间:{$vo.vip_overdue|date="Y-m-d H:i:s",###}
                                    <elseif condition="$vo['is_vip'] == 2" />
                                        vip已过期
                                    <else />
                                    普通用户
                                    </if>
                                </td>
                                <td class="text-center">{$vo['sex'] == 1 ? '男' : ($vo['sex'] == 2 ? '女' : '未知')}</td>
                                <td class="text-center">
                                    <empty name="vo['avatar']">
                                        <a title="默认头像">
                                            <img data-original="__IMG__/defaulticon.png" src="__IMG__/defaulticon.png" width="40" height="40" alt="默认头像">
                                        </a>
                                        <else/>
                                        <img data-original="{$vo.avatar}" src="{$vo.avatar}" width="40" height="40" alt="微信头像">
                                    </empty>
                                </td>
                                <td class="text-center">
                                    <if condition='$vo["is_follow"] eq 1'>
                                        是<else/>否
                                    </if>
                                </td>
                                <td class="text-center">{$vo.gold}个</td>
                                <td class="text-center">{$vo[total]/100}</td>
                                <td class="text-center">
                                    <button type="button" data-id="{$vo.id}" class="btn btn-info" id="watch">查看</button>
                                </td>
                                <td class="text-center">
                                    <button type="button" data-id="{$vo.id}" class="btn btn-success" id="pays">查看</button>
                                </td>
                                <td class="text-center">{$vo.add_time|date='Y-m-d H:i:s',###}</td>
                                <td class="text-center">{$vo.channel}</td>
                                <td class="text-center">
                                    <button type="button" class="btn red getTrajectory" data-id="{$vo.id}" >获取用户轨迹</button>
                                    <if condition='$vo["is_follow"] eq 1'>
                                        <button type="button" class="btn green send" data-id="{$vo.id}" data-dismiss="modal">发送文本消息</button>
                                        <a href="{:U('Fans/editGold',array('id'=>$vo['id']))}" class="btn btn-primary" role="button">
                                        <i class="fa fa-edit"></i>修改金币</a>
                                    </if>
                                </td>
                            </tr>
                        </volist>
                    </if>
                    <if condition="$flag eq 0">
                        <tr>
                            <td colspan="10" style="font-size: 18px;font-weight: bolder;text-align: center;">暂无相关记录</td>
                        </tr>
                    </if>
                </tbody>
            </table>
            {$page}
        </div>
    </div>

    <!--查看消费记录-->
    <div id="show" class="modal fade" tabindex="-1" data-width="650">
    <div class="modal-dialog" role="document">
            <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
            <h4 class="modal-title">消费记录</h4>
        </div>
        <div class="modal-body" id="modalbody">
            <ul class="list-group" id="content">
            </ul>
        </div>
        <div class="modal-footer">

            <button type="button" class="btn green" data-dismiss="modal">确定</button>
        </div>
        </div>
        </div>
    </div>

    <!--充值记录-->
    <div id="paymodal" class="modal fade bs-modal-lg " tabindex="-1">
        <div class='modal-dialog modal-lg'>
            <div class='modal-content'>
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title">充值记录</h4>
                </div>
                <div class="modal-body" id="paymodalbody">
                    <ul class="list-group" id="paybody">
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn green" data-dismiss="modal">
                        确定</button>
                </div>
            </div>
        </div>
    </div>

    <!--反馈处理-->
    <div id="send" class="modal fade" tabindex="-1" data-width="650">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form class="form-horizontal" role="form">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                        <h4 class="modal-title text-center">发送用户文本消息</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="portlet-body form">
                                    <div class="form-body">
                                        <div class="form-group">
                                            <input type="hidden" name="user_id" id="user_id">
                                            <textarea id="main" class="form-control" name="str" rows="6" placeholder="请输入回复的内容"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn default" data-dismiss="modal">取消</button>
                        <button type="button" class="btn green" id="saves">提交</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</block>
<block name="script">
    <script src="__MC__/global/plugins/bootstrap-select/js/bootstrap-select.js" type="text/javascript"></script>
    <script src="__MC__/global/plugins/bootstrap-select/js/i18n/defaults-zh_CN.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
               $("#select").removeClass("selectpicker");
            }

            //获取用户轨迹
            $(".getTrajectory").on('click', function () {
                var user_id = $(this).data('id');
                console.log(user_id);
                layer.open({
                    type: 2,
                    title: '选择内推',
                    shadeClose: false,
                    shade: 0.8,
                    area: ['90%', '90%'],
                    // content: "{:U('Fans/UserTrajectory')}?&user_id=" + user_id, //iframe的url
                        content: "/Back/Fans/UserTrajectory?&user_id=" + user_id, //iframe的url
                    btn: ['确定', '取消'],
                    //按钮对应点击事件回调通知
                    yes: function (index) {
                        layer.close(index);
                    }
                });
            });

            //查看用户的消费记录
            $('body').on('click','#watch',function () {
                var id=$(this).data('id');
                $('#show').modal();
                $.ajax({
                    url:"{:U('Fans/record')}",
                    type:'get',
                    data:{id:id},
                    success:function (data) {
                        if (data.code==0){
                            var str='';
                            var list=data.data
                            for (i in list){
                                str+='<li li class="list-group-item">'+list[i].name;
                                str+='---'+list[i].chapter;
                                str+='---消费时间：'+list[i].add_time;
                                str+='<span class="pull-right" style="color: red;">'+list[i].price+'书币'+'</span></li>';
                            }
                            $('#content').html(str);
                        }else{
                            $('#content').html('暂无消费记录');
                        }
                    }
                })
            });
            //查看用户的充值记录
            $('body').on('click','#pays',function () {
                var id=$(this).data('id');
                var layerIndex = layer.load(1, {time: 0});
                $('#paymodal').modal();
                $.ajax({
                    url:'{:U("Fans/getConsume")}',
                    type:'get',
                    data:{id:id},
                    success:function (data) {
                        if (data.code==0){
                            var str='';
                            var list=data.data;
                            for (i in list){
                                str+='<li li class="list-group-item">'+'金额:'+list[i].pay;
                                if (list[i].type==0){
                                    str+='<span style="margin-left: 30px;">普通充值</span>';
                                }else{
                                    str+='<span style="margin-left: 30px;color:red;">会员充值</span>';
                                }
                                str+='<span class="pull-right" style="margin-left: 30px;color: red;">'+'充值时间:'+list[i].pay_time+'</span>';
                                var splitFen = list[i].from_str.split(';');
                                var split = splitFen[0].split('.');
                                if(split[0] == 'uc'){
                                     str+='<span class="pull-right">'+'充值来源:个人中心</span>';
                                }else if(split[0] == 'txt'){
                                    $.ajaxSettings.async = false;
                                    $.ajax({
                                        type:'get',
                                        timeout:3000,
                                        data:{'movies_id':split[1],'chapter_id':split[2]},
                                        url:'{:U("Fans/getMoveisInfo")}',
                                        success:function(res){
                                            if(res){
                                                str+='<span class="pull-right">'+'充值来源（影片：'+res['movies_name']+'，章节：'+res['chapter_name']+'）</span>';
                                            }
                                        }
                                    })

                                }else if(split[0] == 'ios'){
                                    if(split[1] == 'uc'){
                                         str+='<span class="pull-right">'+'充值来源:iOS个人中心</span>';
                                    }else if(split[1] == 'txt'){
                                        $.ajaxSettings.async = false;
                                        $.ajax({
                                            type:'get',
                                            timeout:3000,
                                            data:{'movies_id':split[2],'chapter_id':split[3]},
                                            url:'{:U("Fans/getMoveisInfo")}',
                                            success:function(res){
                                                if(res){
                                                    str+='<span class="pull-right">'+'充值来源：iOS（影片：'+res['movies_name']+'，章节：'+res['chapter_name']+'）</span>';
                                                }
                                            }
                                        })
                                    }

                                }else if(split[0] == 'android_uc'){
                                    str+='<span class="pull-right">'+'充值来源:安卓个人中心</span>';
                                }else if(split[0] == 'android'){
                                    if(split[1] == 'txt'){
                                        $.ajaxSettings.async = false;
                                        $.ajax({
                                            type:'get',
                                            timeout:3000,
                                            data:{'movies_id':split[2],'chapter_id':split[3]},
                                            url:'{:U("Fans/getMoveisInfo")}',
                                            success:function(res){
                                                if(res){
                                                    str+='<span class="pull-right">'+'充值来源：android（影片：'+res['movies_name']+'，章节：'+res['chapter_name']+'）</span>';
                                                }
                                            }
                                        })
                                    }
                                }else if(split[0] == 'banner'){
                                    str+='<span class="pull-right">'+'充值来源:banner,Id:'+split[1]+'</span>';
                                }else if(split[0] != ''){
                                    str+='<span class="pull-right">'+'充值来源:'+split[0]+'</span>';
                                }else{
                                     str+='<span class="pull-right">'+'充值来源:未知</span>';
                                }

                                str += '</li>';
                            }
                            layer.close(layerIndex);
                            $('#paybody').html(str);
                        }else{
                            layer.close(layerIndex);
                            $('#paybody').html('暂无充值记录');
                        }
                    }
                })
            });

            $('.send').click(function() {
                $('#user_id').val($(this).data('id'));
                $('#send').modal();
            });
            $('#saves').click(function () {
                if (!$('#main').val()) {
                    layer.msg('请输入回复的内容');
                    return;
                }
                $.ajax({
                    url:'{:U("Fans/sendText")}',
                    type:'post',
                    data:$('form').serialize(),
                    dataType:'json',
                    success:function (data) {
                        if (data.code==200){
                            layer.msg('回复成功');
                        }else if(data.code==0){
                            layer.msg('回复失败');
                        }
                    }
                })
            })


        })
    </script>
</block>
